name: Lint, Format, and Smoke Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install the project
        # https://docs.astral.sh/uv/guides/integration/github/#syncing-and-running
        run: uv sync --locked --all-extras --dev

      - name: Run linter (ruff)
        run: uv run ruff check .

      - name: Check formatting (ruff)
        run: uv run ruff format --check .

      - name: Create .env file
        run: |
          cat > .env << EOF
          AZ_STORAGE_EP=${{ secrets.AZ_STORAGE_EP }}
          AZ_STORAGE_RESULTS=${{ secrets.AZ_STORAGE_RESULTS }}
          AZ_STORAGE_DATA=${{ secrets.AZ_STORAGE_DATA }}
          AZ_VALID_PATH=${{ secrets.AZ_VALID_PATH }}
          EOF
        shell: bash

      - name: Run smoke tests
        run: |
          for test in tests/test_*.py; do
            echo "Running $test..."
            uv run python "$test"
          done
        env:
          # Minimum required environment variables for smoke tests
          AZ_STORAGE_EP: ${{ secrets.AZ_STORAGE_EP }}
          AZ_STORAGE_RESULTS: ${{ secrets.AZ_STORAGE_RESULTS }}
          AZ_STORAGE_DATA: ${{ secrets.AZ_STORAGE_DATA }}
          AZ_VALID_PATH: ${{ secrets.AZ_VALID_PATH }}
